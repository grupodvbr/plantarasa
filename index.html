<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Planta Rasa • LICITAR</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
/* =======================
   ESTILO
======================= */
:root{
  --azul:#0b1e39;
  --dourado:#c9a86c;
  --grid:#e3e6eb;
}

body{
  margin:0;
  overflow:hidden;
  font-family:Arial, sans-serif;
}

header{
  background:var(--azul);
  color:white;
  padding:10px;
  display:flex;
  align-items:center;
  gap:10px;
}

header button{
  background:var(--dourado);
  border:none;
  padding:7px 14px;
  border-radius:6px;
  cursor:pointer;
  font-weight:bold;
}

#workspace{
  width:100vw;
  height:100vh;
  position:relative;
  overflow:hidden;
}

#grid{
  width:5000px;
  height:5000px;
  background-image:
    linear-gradient(to right, var(--grid) 1px, transparent 1px),
    linear-gradient(to bottom, var(--grid) 1px, transparent 1px);
  background-size:50px 50px;
  position:absolute;
  top:0;
  left:0;
}

svg{
  position:absolute;
  top:0; left:0;
}

.wall{
  stroke:var(--azul);
  stroke-width:4;
  cursor:pointer;
}

.measure{
  fill:var(--azul);
  font-weight:bold;
  font-size:14px;
}
</style>
</head>

<body>

<header>
  <button onclick="startWall()">Adicionar Parede</button>
  <button onclick="saveProject()">Salvar</button>
  <button onclick="loadProject()">Carregar</button>
  <button onclick="exportPNG()">PNG</button>
  <span style="margin-left:auto; color:#fff; opacity:.8">
    Arraste com o botão do meio • Zoom com scroll
  </span>
</header>

<div id="workspace">
  <div id="grid"></div>
  <svg id="svg" width="5000" height="5000"></svg>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script>
/* =======================
   VARIÁVEIS PRINCIPAIS
======================= */
let svg = document.getElementById("svg");
let grid = document.getElementById("grid");

let startX = null, startY = null;
let addingWall = false;
let scale = 50; // 1m = 50px
let zoom = 1;
let offsetX = 0, offsetY = 0;
let isPanning = false;

let undoStack = [], redoStack = [];

/* =======================
   INICIAR PAREDE
======================= */
function startWall(){
  addingWall = true;
  alert("Clique para iniciar a parede.");
}

/* =======================
   CLIQUES PARA PAREDES
======================= */
svg.addEventListener("click", e=>{
  if(!addingWall) return;

  const rect = svg.getBoundingClientRect();
  let x = (e.clientX - rect.left - offsetX)/zoom;
  let y = (e.clientY - rect.top - offsetY)/zoom;

  if(startX === null){
    startX = x; startY = y;
    return;
  }

  let dx = x - startX;
  let dy = y - startY;
  let distReal = Math.sqrt(dx*dx + dy*dy) / scale;

  let medida = prompt("Comprimento da parede (metros):", distReal.toFixed(2));
  if(!medida){ resetWall(); return; }

  let px = medida * scale;
  let ang = Math.atan2(dy, dx);

  let x2 = startX + Math.cos(ang)*px;
  let y2 = startY + Math.sin(ang)*px;

  desenharParede(startX, startY, x2, y2, medida);

  saveState();
  resetWall();
});

function resetWall(){
  startX = null;
  startY = null;
  addingWall = false;
}

/* =======================
   DESENHAR PAREDE
======================= */
function desenharParede(x1,y1,x2,y2,medida){
  let line = document.createElementNS("http://www.w3.org/2000/svg","line");
  line.setAttribute("x1", x1);
  line.setAttribute("y1", y1);
  line.setAttribute("x2", x2);
  line.setAttribute("y2", y2);
  line.setAttribute("class", "wall");
  line.addEventListener("click", ()=> deletarElemento(line));
  svg.appendChild(line);

  let mx = (x1 + x2)/2;
  let my = (y1 + y2)/2 - 10;

  let txt = document.createElementNS("http://www.w3.org/2000/svg","text");
  txt.setAttribute("x", mx);
  txt.setAttribute("y", my);
  txt.setAttribute("class","measure");
  txt.textContent = medida + " m";
  txt.addEventListener("click", ()=> deletarElemento(line, txt));
  svg.appendChild(txt);
}

/* =======================
   DELETAR ELEMENTO
======================= */
function deletarElemento(line, txt=null){
  if(confirm("Excluir esta parede?")){
    line.remove();
    if(txt) txt.remove();
    saveState();
  }
}

/* =======================
   ZOOM
======================= */
document.addEventListener("wheel", e=>{
  e.preventDefault();
  zoom += (e.deltaY > 0 ? -0.1 : 0.1);
  zoom = Math.max(0.3, Math.min(zoom, 4));
  aplicarTransform();
},{passive:false});

/* =======================
   PAN
======================= */
document.addEventListener("mousedown", e=>{
  if(e.button === 1){
    isPanning = true;
    panStartX = e.clientX - offsetX;
    panStartY = e.clientY - offsetY;
  }
});
document.addEventListener("mouseup", ()=> isPanning=false);
document.addEventListener("mousemove", e=>{
  if(isPanning){
    offsetX = e.clientX - panStartX;
    offsetY = e.clientY - panStartY;
    aplicarTransform();
  }
});

function aplicarTransform(){
  svg.style.transform = `translate(${offsetX}px,${offsetY}px) scale(${zoom})`;
  grid.style.transform = `translate(${offsetX}px,${offsetY}px) scale(${zoom})`;
}

/* =======================
   SALVAR
======================= */
function saveProject(){
  saveState();
  let blob = new Blob([svg.innerHTML], {type:"text/plain"});
  let url = URL.createObjectURL(blob);
  let a = document.createElement("a");
  a.href = url;
  a.download = "planta.json";
  a.click();
}

/* =======================
   CARREGAR
======================= */
function loadProject(){
  let input = document.createElement("input");
  input.type = "file";
  input.onchange = e=>{
    let file = e.target.files[0];
    let reader = new FileReader();
    reader.onload = evt=>{
      svg.innerHTML = evt.target.result;
    };
    reader.readAsText(file);
  };
  input.click();
}

/* =======================
   EXPORTAR PNG
======================= */
function exportPNG(){
  html2canvas(document.getElementById("workspace")).then(canvas=>{
    let a = document.createElement("a");
    a.href = canvas.toDataURL("image/png");
    a.download = "planta.png";
    a.click();
  });
}

/* =======================
   UNDO/REDO
======================= */
function saveState(){
  undoStack.push(svg.innerHTML);
  redoStack = [];
}

function undo(){
  if(undoStack.length === 0) return;
  redoStack.push(svg.innerHTML);
  svg.innerHTML = undoStack.pop();
}

function redo(){
  if(redoStack.length === 0) return;
  undoStack.push(svg.innerHTML);
  svg.innerHTML = redoStack.pop();
}
</script>

</body>
</html>
