<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Planta Builder • Completo</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
/* =======================
   ESTILO GERAL
======================= */
:root{
  --azul:#0b1e39;
  --dourado:#c9a86c;
  --grid:#e3e6eb;
}

body{
  margin:0;
  overflow:hidden;
  font-family:Arial, sans-serif;
}

header{
  background:var(--azul);
  color:white;
  padding:10px;
  display:flex;
  align-items:center;
  gap:8px;
}

header button{
  background:var(--dourado);
  border:none;
  padding:8px 15px;
  border-radius:6px;
  cursor:pointer;
  font-weight:bold;
}

#workspace{
  width:100vw;
  height:100vh;
  position:relative;
  overflow:hidden;
}

#grid{
  width:5000px;
  height:5000px;
  background-image:
    linear-gradient(to right, var(--grid) 1px, transparent 1px),
    linear-gradient(to bottom, var(--grid) 1px, transparent 1px);
  background-size:50px 50px;
  position:absolute;
  top:0;
  left:0;
}

svg{
  position:absolute;
  top:0;
  left:0;
}

.wall{
  stroke:var(--azul);
  stroke-width:5;
  cursor:pointer;
}

.door{
  stroke:#d46a00;
  stroke-width:5;
  cursor:pointer;
}

.window{
  stroke:#00a2ff;
  stroke-width:5;
  cursor:pointer;
}

.measure{
  fill:var(--azul);
  font-size:14px;
  font-weight:bold;
  pointer-events:auto;
  cursor:pointer;
}
</style>
</head>

<body>

<header>
  <button onclick="mode='wall'">Parede</button>
  <button onclick="mode='door'">Porta</button>
  <button onclick="mode='window'">Janela</button>
  <button onclick="saveProject()">Salvar</button>
  <button onclick="loadProject()">Carregar</button>
  <button onclick="exportPNG()">PNG</button>
  <span style="margin-left:auto; color:white; opacity:.8">Zoom = scroll • Mover tela = botão do meio</span>
</header>

<div id="workspace">
  <div id="grid"></div>
  <svg id="svg" width="5000" height="5000"></svg>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

<script>
/* =======================
   VARIÁVEIS GLOBAIS
======================= */
let svg = document.getElementById("svg");
let grid = document.getElementById("grid");

let mode = "wall";
let startX=null, startY=null;
let scale = 50;
let zoom = 1;
let offsetX = 0, offsetY = 0;
let isPanning = false;

/* =======================
   SNAP TO GRID
======================= */
function snap(v){
  return Math.round(v / 10) * 10;
}

/* =======================
   DESENHO DE PAREDES
======================= */
svg.addEventListener("click", e=>{
  const rect = svg.getBoundingClientRect();
  let x = (e.clientX - rect.left - offsetX)/zoom;
  let y = (e.clientY - rect.top - offsetY)/zoom;

  x = snap(x);
  y = snap(y);

  if(startX === null){
    startX=x; startY=y;
    return;
  }

  if(mode==="wall") criarParede(x,y);
  if(mode==="door") criarPorta(x,y);
  if(mode==="window") criarJanela(x,y);

  startX=null; startY=null;
});

/* =======================
   PAREDE
======================= */
function criarParede(x,y){
  let dx = x - startX;
  let dy = y - startY;
  let dist = Math.sqrt(dx*dx + dy*dy)/scale;

  let medida = prompt("Comprimento da parede (m):", dist.toFixed(2));
  if(!medida) return;

  let px = medida*scale;
  let ang = Math.atan2(dy,dx);

  let x2 = startX + Math.cos(ang)*px;
  let y2 = startY + Math.sin(ang)*px;

  let l = document.createElementNS("http://www.w3.org/2000/svg","line");
  l.setAttribute("x1", startX);
  l.setAttribute("y1", startY);
  l.setAttribute("x2", x2);
  l.setAttribute("y2", y2);
  l.setAttribute("class","wall");
  l.addEventListener("mousedown",()=>selecionar(l));
  svg.appendChild(l);

  criarCota(startX,startY,x2,y2,medida);
}

/* =======================
   PORTA
======================= */
function criarPorta(x,y){
  let w = 0.8 * scale;
  let l = document.createElementNS("http://www.w3.org/2000/svg","line");
  l.setAttribute("x1", x);
  l.setAttribute("y1", y);
  l.setAttribute("x2", x+w);
  l.setAttribute("y2", y);
  l.setAttribute("class","door");
  l.addEventListener("mousedown",()=>selecionar(l));
  svg.appendChild(l);
}

/* =======================
   JANELA
======================= */
function criarJanela(x,y){
  let w = 1.2 * scale;
  let r = document.createElementNS("http://www.w3.org/2000/svg","rect");
  r.setAttribute("x", x);
  r.setAttribute("y", y-5);
  r.setAttribute("width", w);
  r.setAttribute("height", 10);
  r.setAttribute("class","window");
  r.addEventListener("mousedown",()=>selecionar(r));
  svg.appendChild(r);
}

/* =======================
   COTAS
======================= */
function criarCota(x1,y1,x2,y2,medida){
  let mx = (x1+x2)/2;
  let my = (y1+y2)/2 - 10;

  let t = document.createElementNS("http://www.w3.org/2000/svg","text");
  t.setAttribute("x", mx);
  t.setAttribute("y", my);
  t.setAttribute("class","measure");
  t.textContent = medida + " m";
  t.addEventListener("click",()=>editarCota(t));
  svg.appendChild(t);
}

/* editar cota */
function editarCota(t){
  let nova = prompt("Nova medida:", t.textContent.replace(" m",""));
  if(nova){
    t.textContent = nova + " m";
  }
}

/* =======================
   SELEÇÃO + DELETE
======================= */
function selecionar(el){
  document.addEventListener("keydown", e=>{
    if(e.key==="Delete"){
      el.remove();
    }
  }, {once:true});
}

/* =======================
   ZOOM
======================= */
document.addEventListener("wheel", e=>{
  e.preventDefault();
  zoom += (e.deltaY>0?-0.1:0.1);
  zoom=Math.max(.3,Math.min(4,zoom));
  aplicarTransform();
},{passive:false});

/* PAN */
document.addEventListener("mousedown", e=>{
  if(e.button===1){
    isPanning=true;
    panSX=e.clientX-offsetX;
    panSY=e.clientY-offsetY;
  }
});
document.addEventListener("mouseup",()=>isPanning=false);
document.addEventListener("mousemove",e=>{
  if(isPanning){
    offsetX=e.clientX-panSX;
    offsetY=e.clientY-panSY;
    aplicarTransform();
  }
});

function aplicarTransform(){
  svg.style.transform=`translate(${offsetX}px,${offsetY}px) scale(${zoom})`;
  grid.style.transform=`translate(${offsetX}px,${offsetY}px) scale(${zoom})`;
}

/* =======================
   SALVAR / CARREGAR
======================= */
function saveProject(){
  let data = svg.innerHTML;
  let blob=new Blob([data],{type:"text/plain"});
  let a=document.createElement("a");
  a.href=URL.createObjectURL(blob);
  a.download="planta.json";
  a.click();
}

function loadProject(){
  let i=document.createElement("input");
  i.type="file";
  i.onchange=e=>{
    let f=e.target.files[0];
    let r=new FileReader();
    r.onload=ev=>svg.innerHTML=ev.target.result;
    r.readAsText(f);
  };
  i.click();
}

/* =======================
   PNG
======================= */
function exportPNG(){
  html2canvas(document.getElementById("workspace")).then(c=>{
    let a=document.createElement("a");
    a.href=c.toDataURL();
    a.download="planta.png";
    a.click();
  });
}
</script>

</body>
</html>
