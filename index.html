<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8" />
<title>Planta Builder • LICITAR</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
/* ================================
   ESTILO GERAL
================================ */
:root{
  --azul:#0b1e39;
  --dourado:#c9a86c;
  --grid:#e3e6eb;
}

body{
  margin:0;
  font-family:Arial, sans-serif;
  overflow:hidden;
  background:#fff;
}

/* TOPO */
header{
  background:var(--azul);
  color:white;
  padding:12px;
  display:flex;
  justify-content:space-between;
  align-items:center;
}

header .title{
  font-size:20px;
  font-weight:bold;
}

header button{
  background:var(--dourado);
  border:none;
  padding:7px 14px;
  border-radius:6px;
  margin-left:5px;
  cursor:pointer;
  font-weight:bold;
  color:#111;
}

/* ÁREA DE TRABALHO */
#workspace{
  width:100vw;
  height:100vh;
  overflow:hidden;
  position:relative;
}

#grid{
  width:4000px;
  height:4000px;
  background-image:
    linear-gradient(to right, var(--grid) 1px, transparent 1px),
    linear-gradient(to bottom, var(--grid) 1px, transparent 1px);
  background-size:50px 50px;
  position:absolute;
  top:0;
  left:0;
}

#canvas{
  position:absolute;
  top:0;
  left:0;
}

.wall{
  stroke:var(--azul);
  stroke-width:4;
  cursor:pointer;
}

.measure{
  fill:var(--azul);
  font-size:14px;
  font-weight:bold;
}

.door, .window{
  stroke:#d46800;
  stroke-width:4;
}

.object{
  fill:rgba(0,0,0,0.05);
  stroke:#333;
  stroke-width:2;
}
</style>
</head>

<body>

<header>
  <div class="title">LICITAR • Planta Builder</div>

  <div>
    <button onclick="setMode('wall')">Parede</button>
    <button onclick="setMode('door')">Porta</button>
    <button onclick="setMode('window')">Janela</button>
    <button onclick="setMode('object')">Móvel</button>
    <button onclick="setMode('dimension')">Cota</button>
    <button onclick="undo()">↶</button>
    <button onclick="redo()">↷</button>
    <button onclick="saveProject()">Salvar</button>
    <button onclick="loadProject()">Carregar</button>
    <button onclick="exportPNG()">PNG</button>
  </div>
</header>

<div id="workspace">
  <div id="grid"></div>
  <svg id="canvas" width="4000" height="4000"></svg>
</div>

<script>
/* ============================================
   VARIÁVEIS PRINCIPAIS
============================================ */
let canvas = document.getElementById("canvas");
let grid = document.getElementById("grid");

let mode = null;
let zoom = 1;
let offsetX = 0, offsetY = 0;

let startX = null;
let startY = null;

let scale = 50; // 1m = 50px
let isPanning = false;

let undoStack = [];
let redoStack = [];

/* ============================================
   CONTROLES DE MODO
============================================ */
function setMode(m){
  mode = m;
  alert("Modo: " + m);
}

/* ============================================
   ZOOM
============================================ */
document.addEventListener("wheel", e=>{
  e.preventDefault();
  zoom += (e.deltaY > 0 ? -0.1 : 0.1);
  zoom = Math.min(Math.max(zoom, 0.3), 4);
  applyTransform();
},{passive:false});

/* PAN */
document.addEventListener("mousedown", e=>{
  if(e.button === 1 || e.code === "Space"){
    isPanning = true;
    panStartX = e.clientX - offsetX;
    panStartY = e.clientY - offsetY;
  }
});

document.addEventListener("mouseup", ()=> isPanning=false);

document.addEventListener("mousemove", e=>{
  if(isPanning){
    offsetX = e.clientX - panStartX;
    offsetY = e.clientY - panStartY;
    applyTransform();
  }
});

function applyTransform(){
  canvas.style.transform = `translate(${offsetX}px,${offsetY}px) scale(${zoom})`;
  grid.style.transform = `translate(${offsetX}px,${offsetY}px) scale(${zoom})`;
}

/* ============================================
   CLIQUE PARA DESENHAR
============================================ */
canvas.addEventListener("click", e=>{
  const rect = canvas.getBoundingClientRect();
  let x = (e.clientX - rect.left - offsetX)/zoom;
  let y = (e.clientY - rect.top - offsetY)/zoom;

  if(startX === null){
    startX = x;
    startY = y;
    return;
  }

  if(mode === "wall"){
    criarParede(x,y);
  }
  if(mode === "door"){
    criarPorta(x,y);
  }
  if(mode === "window"){
    criarJanela(x,y);
  }
  if(mode === "object"){
    criarObjeto(x,y);
  }
  if(mode === "dimension"){
    criarCota(x,y);
  }

  startX = null;
  startY = null;
});

/* ============================================
   PAREDES
============================================ */
function criarParede(x,y){
  let dx = x - startX;
  let dy = y - startY;
  let distReal = Math.sqrt(dx*dx + dy*dy) / scale;

  let medida = prompt("Comprimento da parede (m):", distReal.toFixed(2));
  if(!medida) return;

  let px = medida * scale;
  let ang = Math.atan2(dy, dx);

  let x2 = startX + Math.cos(ang)*px;
  let y2 = startY + Math.sin(ang)*px;

  let line = document.createElementNS("http://www.w3.org/2000/svg","line");
  line.setAttribute("x1", startX);
  line.setAttribute("y1", startY);
  line.setAttribute("x2", x2);
  line.setAttribute("y2", y2);
  line.setAttribute("class","wall");
  canvas.appendChild(line);

  addMeasure(startX,startY,x2,y2,medida);

  saveState();
}

/* ============================================
   PORTAS
============================================ */
function criarPorta(x,y){
  let w = 0.80 * scale;
  let line = document.createElementNS("http://www.w3.org/2000/svg","line");
  line.setAttribute("x1", x);
  line.setAttribute("y1", y);
  line.setAttribute("x2", x+w);
  line.setAttribute("y2", y);
  line.setAttribute("class","door");
  canvas.appendChild(line);
  saveState();
}

/* ============================================
   JANELAS
============================================ */
function criarJanela(x,y){
  let w = 1.20 * scale;
  let line = document.createElementNS("http://www.w3.org/2000/svg","rect");
  line.setAttribute("x", x);
  line.setAttribute("y", y);
  line.setAttribute("width", w);
  line.setAttribute("height", 10);
  line.setAttribute("class","window");
  canvas.appendChild(line);
  saveState();
}

/* ============================================
   MÓVEIS
============================================ */
function criarObjeto(x,y){
  let rect = document.createElementNS("http://www.w3.org/2000/svg","rect");
  rect.setAttribute("x", x-25);
  rect.setAttribute("y", y-25);
  rect.setAttribute("width", 80);
  rect.setAttribute("height", 50);
  rect.setAttribute("class","object");
  canvas.appendChild(rect);
  saveState();
}

/* ============================================
   COTAS
============================================ */
function addMeasure(x1,y1,x2,y2,medida){
  let mx = (x1+x2)/2;
  let my = (y1+y2)/2;

  let txt = document.createElementNS("http://www.w3.org/2000/svg","text");
  txt.setAttribute("x", mx);
  txt.setAttribute("y", my - 10);
  txt.setAttribute("class","measure");
  txt.textContent = medida + " m";
  canvas.appendChild(txt);
  return txt;
}

function criarCota(x,y){
  let dx = x - startX;
  let dy = y - startY;
  let dist = Math.sqrt(dx*dx + dy*dy) / scale;

  addMeasure(startX,startY,x,y,dist.toFixed(2));
  saveState();
}

/* ============================================
   UNDO / REDO
============================================ */
function saveState(){
  undoStack.push(canvas.innerHTML);
  redoStack = [];
}

function undo(){
  if(undoStack.length === 0) return;
  redoStack.push(canvas.innerHTML);
  canvas.innerHTML = undoStack.pop();
}

function redo(){
  if(redoStack.length === 0) return;
  undoStack.push(canvas.innerHTML);
  canvas.innerHTML = redoStack.pop();
}

/* ============================================
   SALVAR / CARREGAR
============================================ */
function saveProject(){
  let data = canvas.innerHTML;
  let blob = new Blob([data], {type:'text/plain'});
  let url = URL.createObjectURL(blob);
  let a = document.createElement("a");
  a.href = url;
  a.download = "planta_licitar.json";
  a.click();
}

function loadProject(){
  let input = document.createElement("input");
  input.type = "file";
  input.onchange = e=>{
    let file = e.target.files[0];
    let reader = new FileReader();
    reader.onload = evt=>{
      canvas.innerHTML = evt.target.result;
    };
    reader.readAsText(file);
  };
  input.click();
}

/* ============================================
   EXPORTAR PNG
============================================ */
function exportPNG(){
  html2canvas(document.body).then(c=>{
    let a = document.createElement("a");
    a.href = c.toDataURL("image/png");
    a.download = "planta.png";
    a.click();
  });
}
</script>

<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

</body>
</html>
